services:
  v2ray:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: v2ray-core
    restart: unless-stopped
    ports:
      - "${V2RAY_PORT:-11000}:${V2RAY_PORT:-11000}"
    volumes:
      - ./config.json:/etc/v2ray/config.json.template:ro
      - v2ray_logs:/var/log/v2ray
    environment:
      - V2RAY_UUID=${V2RAY_UUID}
      - V2RAY_UUID_FALLBACK=${V2RAY_UUID_FALLBACK}
      - V2RAY_UUID_RANDOMIZE=${V2RAY_UUID_RANDOMIZE}
      - V2RAY_PATH=${V2RAY_PATH}
      - V2RAY_PORT=${V2RAY_PORT}
      - V2RAY_SERVER=${V2RAY_SERVER}
      - V2RAY_LOG_LEVEL=${V2RAY_LOG_LEVEL:-warning}
      - DNS_QUERY_STRATEGY=${DNS_QUERY_STRATEGY}
      - DNS_DISABLE_CACHE=${DNS_DISABLE_CACHE}
      - V2RAY_BUFFER_SIZE=${V2RAY_BUFFER_SIZE}
    healthcheck:
      test: ["CMD", "pgrep", "-f", "v2ray"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 32768
        hard: 32768
    cap_add:
      - NET_ADMIN
      - SYS_RESOURCE
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:noexec,nosuid,size=256m
      - /var/tmp:noexec,nosuid,size=256m
      - /var/run:noexec,nosuid,size=32m
    shm_size: 256m

volumes:
  v2ray_logs:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=100m,uid=1000,gid=1000
